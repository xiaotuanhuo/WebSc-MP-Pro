<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
	<title>超级管理员</title>
	
	<!-- Google font file. If you want you can change. -->
	<link href="https://fonts.googleapis.com/css?family=Nunito:300,400,600,700,900" rel="stylesheet">
	<!-- Fontawesome font file css -->
	<!-- <link rel="stylesheet" href="https://www.jq22.com/jquery/font-awesome.4.7.0.css"> -->
	<link rel="stylesheet" type="text/css" th:href="@{/css/font-awesome.min.css}">
	<!-- Template global css file. Requared all pages -->
	<link rel="stylesheet" type="text/css" th:href="@{/css/global.style.css}">
	<link rel="stylesheet" href="https://www.jq22.com/jquery/bootstrap-4.2.1.css">
	<!-- <link rel="stylesheet" th:href="@{/css/animate.min.css}"> -->
	<link rel="stylesheet" th:href="@{/css/mescroll.min.css}">
	<link rel="stylesheet" th:href="@{/css/Mdate.css}">
</head>

<body>
	<div class="wrapper">
		<div class="nav-menu">
			<nav class="menu">
				<!-- Menu navigation start -->
				<div class="nav-container menu-container">
					<div class="d-flex align-items-center justify-content-between container-list">
						<div class="menu-list-flex align-items-center">
							<div>
								<h5 class="text-muted">姓名</h5>
							</div>
						</div>
						<div>
							<h6 class="text-muted menu-info">[[${user.userName}]]</h6>
						</div>
					</div>
					<div class="d-flex align-items-center justify-content-between container-list">
						<div class="menu-list-flex align-items-center">
							<div>
								<h5 class="text-muted">性别</h5>
							</div>
						</div>
						<div>
							<div th:switch="${user.sex}">
								<div th:case="'0'">
									<h6 class="text-muted menu-info">女</h6>
								</div>
								<div th:case="*">
									<h6 class="text-muted menu-info">男</h6>
								</div>
							</div>
						</div>
					</div>
					<div class="d-flex align-items-center justify-content-between container-list">
						<div class="menu-list-flex align-items-center">
							<div>
								<h5 class="text-muted">手机</h5>
							</div>
						</div>
						<div>
							<h6 class="text-muted menu-info">[[${user.phone}]]</h6>
						</div>
					</div>
					<div class="d-flex align-items-center justify-content-between container-list">
						<div class="menu-list-flex align-items-center">
							<div>
								<h5 class="text-muted">角色</h5>
							</div>
						</div>
						<div>
							<h6 class="text-muted menu-info">[[${user.roleName}]]</h6>
						</div>
					</div>
					<div class="d-flex align-items-center justify-content-between container-list">
						<div class="menu-list-flex align-items-center">
							<div>
								<h5 class="text-muted">机构</h5>
							</div>
						</div>
						<div>
							<h6 class="text-muted menu-info">[[${user.deptName}]]</h6>
						</div>
					</div>
					<div class="d-flex align-items-center justify-content-between container-list">
						<div class="menu-list-flex align-items-center">
							<div>
								<h5 class="text-muted">区域</h5>
							</div>
						</div>
						<div>
							<h6 class="text-muted menu-info">[[${user.districtName}]]</h6>
						</div>
					</div>
					
					<button class="button circle red block menu-logout">登出</button>
				</div>
				<!-- Menu navigation end -->
			</nav>
		</div>
		
		<div class="wrapper-inline">
			<!-- Header area start -->
			<header class="no-background"> <!-- extra class no-background -->
				<div class="navi-menu-button">
					<em></em>
					<em></em>
					<em></em>
				</div>
			</header>
			<!-- Header area end -->
			
			<!-- Page content start -->
			<main class="margin mt-0">
				<div class="dash-balance">
					<div class="dash-content relative">
						<h3 class="w-text">SuCheng</h3>
					</div>
				</div>
				
				<section class="bal-section container">
					<div class="trader-info">
						<ul class="trader-info-list list-unstyled">
							<li>
								<div class="profile1"></div>
								<h2>[[${statsYMD.day}]]</h2>
								<small class="txt-muted">日手术量</small>
							</li>
							<li>
								<div class="profile2"></div>
								<h2>[[${statsYMD.month}]]</h2>
								<small class="txt-muted">月手术量</small>
							</li>
							<li>
								<div class="profile3"></div>
								<h2>[[${statsYMD.year}]]</h2>
								<small class="txt-muted">年手术量</small>
							</li>
						</ul>
					</div>
				</section>
				
				<!-- charts start -->
				<section class="section container">
					<div class="chart-body">
						<div class="align-items-center chart-content">
							<div class="col-12">
								<div class="advertising-wrapper">
									<canvas id="container" class="chart-container"></canvas>
								</div>
							</div>
						</div>
					</div>
				</section>
				
				<!-- charts area end -->
				
				<!-- charts start -->
				<section class="section container refer">
					<div class="chart-body">
						<div class="align-items-center chart-content">
							<div class="col-12">
								<div class="advertising-wrapper">
									<canvas id="container2" class="chart-container"></canvas>
								</div>
							</div>
						</div>
					</div>
				</section>
				
				<!-- charts area end -->
				
				<section class="wallets-list container">
					<!--expendable list item -->
					<div class="expandable-item accordion" data-group="accordion">
						<div class="expandable-header purp">
							<i class="list-arrow fa fa-angle-down"></i>
							<h3 class="list-title">统计报表</h3>
						</div>
						<div class="expandable-content">
							<div class="padding-content">
								<div class="recent-trans">
									<div class="form-group">
										<span>开始时间</span>
										<input type="text" id="dateSelector_begin" class="form-field">
									</div>
									<div class="form-group">
										<span>结束时间</span>
										<input type="text" id="dateSelector_end" class="form-field">
									</div>
									<div id="distpicker11">
										<div class="form-group">
											<label class="sr-only" for="province">province</label>
											<select class="form-control" id="province"></select>
										</div>
										<div class="form-group">
											<label class="sr-only" for="city">city</label>
											<select class="form-control" id="city"></select>
										</div>
										<div class="form-group">
											<label class="sr-only" for="district">district</label>
											<select class="form-control" id="district"></select>
										</div>
									</div>
									<div class="form-group">
										<span>医疗机构</span>
										<select class="form-field" id="orgs">
											<option style='display: none'></option>
										</select>
									</div>
									<div>
										<a id="reportingBtn" class="button circle block blue">查询</a>
									</div>
                                </div>
							</div>
						</div>
					</div>
				</section>
				
				<section class="container">
					<ul id="reporting" class="transaction-list list-unstyled"></ul>
				</section>
				
			</main>
			<!-- Page content end -->
		</div>
	</div>
	<!--Page loader DOM Elements. Requared all pages-->
	<div class="sweet-loader">
		<div class="box">
		  	<div class="circle1"></div>
		  	<div class="circle2"></div>
		  	<div class="circle3"></div>
		</div>
	</div>
	
	<!-- JQuery library file. requared all pages -->
	<script th:src="@{/js/jquery.min.js}"></script>
    <!-- <script th:src="@{/js/swiper.animate.min.js}"></script> -->
	<!-- F2 阿里可视化插件 -->
	<script src="https://gw.alipayobjects.com/os/lib/antv/f2/3.7.3/dist/f2-all.min.js"></script>
	
	<!-- 下拉刷新 下拉加载插件 -->
	<script th:src="@{/js/mescroll.min.js}"></script>		
	<!-- Template global script file. requared all pages -->
	<script th:src="@{/js/global.script.js}"></script>
	<!-- 日期选择插件 -->
	<script th:src="@{/js/iScroll.js}"></script>
	<script th:src="@{/js/Mdate.js}"></script>
	
	<script th:src="@{/js/distpicker.data.js}"></script>
	<script th:src="@{/js/distpicker.js}"></script>
	<!-- <script th:src="@{/js/main.js}"></script> -->
	
	<script type="text/javascript">
		$(document).ready(function() {
			drawMonthCount();
			drawTopProvince();
			getOrganizations("", "", "");
			getReporting("", "", "", "", "");
		});
		
		// 监听省市区的变化 更新机构列表
		$("#province").on("change", function() {
			var provinceCode = $("#province").find(':selected').data('code');
			$("#orgs").empty();
			var organizationDom = document.getElementById("orgs");
			var orgName = "";
			var optionDom = document.createElement("option");
			optionDom.setAttribute('style', 'display: none;');
			optionDom.innerHTML = orgName;
			organizationDom.appendChild(optionDom);
			getOrganizations(provinceCode, "", "");
		});
		$("#city").on("change", function() {
			var cityCode = $("#city").find(':selected').data('code');
			$("#orgs").empty();
			var organizationDom = document.getElementById("orgs");
			var orgName = "";
			var optionDom = document.createElement("option");
			optionDom.setAttribute('style', 'display: none;');
			optionDom.innerHTML = orgName;
			organizationDom.appendChild(optionDom);
			getOrganizations("", cityCode, "");
		});
		$("#district").on("change", function() {
			var areaCode = $("#district").find(':selected').data('code');
			$("#orgs").empty();
			var organizationDom = document.getElementById("orgs");
			var orgName = "";
			var optionDom = document.createElement("option");
			optionDom.setAttribute('style', 'display: none;');
			optionDom.innerHTML = orgName;
			organizationDom.appendChild(optionDom);
			getOrganizations("", "", areaCode);
		});
	
		$('#reportingBtn').on("click", function() {
			var begin = $("#dateSelector_begin").val();
			var end = $("#dateSelector_end").val();
			var pCode = $("#province").find(':selected').data('code');
			var cCode = $("#city").find(':selected').data('code');
			var dCode = $("#district").find(':selected').data('code');
			var oCode = $("#orgs").find(':selected').data('code');
			$("#reporting").empty();
			getReporting(begin, end, pCode, cCode, dCode, oCode);
		});
		
		/* 近3年每月手术统计 */
		function drawMonthCount() {
			$.ajax({
		    	type: "POST",
		    	dataType: "json",
		    	url: "statsMonths",
		    	contentType: "application/json",
		    	success: function (result) {
        			if(result.code == 0) {
        				var data = result.data;
        				var chart = new F2.Chart({
    		    			id : 'container',
    		    			pixelRatio : window.devicePixelRatio
    		    		});
    		    		chart.source(data);
    		    		chart.tooltip({
    		    			showTitle: true,
    		    			showCrosshairs : true
    		    		});
    		    		chart.legend({
    		    			align: 'center',
    		    			marker: function marker(x, y, r, ctx) {
    		    				ctx.lineWidth = 1;
    		    				ctx.strokeStyle = ctx.fillStyle;
    		    				ctx.moveTo(x - r - 3, y);
    		    				ctx.lineTo(x + r + 3, y);
    		    				ctx.stroke();
    		    				ctx.arc(x, y, r, 0, Math.PI * 2, false);
    		    				ctx.fill();
    		    			}
    		    		});
    		    		chart.line().position('month*count').color('year');
    		    		chart.point().position('month*count').color('year').style({
    		    			lineWidth : 1,
    		    			stroke : '#fff'
    		    		});
    		    		chart.render();
        			} else {
        				
        			}
		    	},
		    	error: function() {
		    		
		    	}
			});
		}
		
		function drawTopProvince() {
			$.ajax({
		    	type: "POST",
		    	dataType: "json",
		    	url: "statsProvince",
		    	contentType: "application/json",
		    	success: function (result) {
        			if(result.code == 0) {
        				var data2 = result.data;
        				const chart2 = new F2.Chart({
        					  id: 'container2',
        					  pixelRatio: window.devicePixelRatio
        					});

        					chart2.source(data2);
        					chart2.coord('polar', {
        					  transposed: true,
        					  radius: 0.75
        					});
        					chart2.legend(false);
        					chart2.axis(false);
        					chart2.tooltip(false);

        					// 添加饼图文本
        					chart2.pieLabel({
        					  sidePadding: 40,
        					  label1: function label1(data2, color) {
        					    return {
        					      text: data2.cityName,
        					      fill: color
        					    };
        					  },
        					  label2: function label2(data2) {
        					    return {
        					      text: data2.count,
        					      fill: '#808080',
        					      fontWeight: 'bold'
        					    };
        					  }
        					});

        					chart2.interval()
        					  .position('pieConst*count')
        					  .color('cityName', ['#1890FF', '#13C2C2', '#2FC25B', '#FACC14', '#F04864'])
        					  .adjust('stack');
        					chart2.render();
        			} else {
        				
        			}
		    	},
		    	error: function() {
		    		
		    	}
			});
		}
		
		function getOrganizations(province, city, area) {
			$.ajax({
		    	type: "POST",
		    	dataType: "json",
		    	url: 'organizations?province=' + province + "&city=" + city + "&area=" + area,
		    	contentType: "application/json",
		    	success: function (result) {
		    		var organizations = result.data;
		    		if (organizations.length > 0) {
		    			var organizationDom = document.getElementById("orgs");
		    			for (var i = 0; i < organizations.length; i++) {
		    				var orgName = organizations[i].name;
		    				var optionDom = document.createElement("option");
		    				optionDom.setAttribute("data-code", organizations[i].id);
		    				optionDom.innerHTML = orgName;
		    				organizationDom.appendChild(optionDom);
		    			}
		    		}
		    	},
		    	error: function() {
		    		
		    	}
			});
		}
		
		function getReporting(begin, end, province, city, area, orgId) {
			var jsonData = JSON.stringify({'beginTime': begin, 'endTime': end, 'province': province, 'city': city, 'area': area, 'orgId': orgId});
			$.ajax({
		    	type: "POST",
		    	data: jsonData,
		    	dataType: "json",
		    	url: 'reporting',
		    	contentType: "application/json",
		    	success: function (result) {
		    		var data = result.data;
		    		var ulDom = document.getElementById("reporting");
		    		
		    		for (var i = 0; i < data.length; i++) {
		    			var newObj = data[i];
						var str = '<div class="d-flex align-items-center justify-content-between">';
						str += '<div class="d-flex align-items-center">';
						str += '<div class="ml-10">';
						str += '<h6 class="coin-name">' + newObj.orgName + '</h6>';
						str += '<small class="text-muted">' + newObj.wholeDistrict
								+ '</small>';
						str += '</div>';
						str += '</div>';
						str += '<div>';
						str += '<small class="d-block mb-0 txt-muted">'
								+ newObj.count + '</small>';
						str += '</div>';
						str += '</div>';
						var liDom = document.createElement("li");
						liDom.innerHTML = str;
						
						ulDom.appendChild(liDom);//加在列表的后面,上拉加载
		    		}
		    	},
		    	error: function() {
		    		
		    	}
			});
		}
		
		$("#dateSelector_begin").focus(function() {
			document.activeElement.blur();
		});
		new Mdate("dateSelector_begin");
		$("#dateSelector_end").focus(function() {
			document.activeElement.blur();
		});
		new Mdate("dateSelector_end");
		$("#distpicker11").distpicker({
			autoSelect : false
		});

		$(".menu-logout").on("click", function() {
			location.href = "logout";
		});
	</script>
</body>

</html>
